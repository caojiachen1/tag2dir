# tag2dir

基于 Web 的图片分类移动工具：从图片元数据中提取“人员”和“标签”，并将图片移动到以人员为名的文件夹中（若无人员信息则忽略）。提供图片缩略图预览、移动计划预览和执行。支持 Windows。

## 功能
- 扫描目录，提取每张图片的人员与标签（优先 XMP，兼容 EXIF XPKeywords）
- 扫描过程实时显示：逐张图片加载缩略图并展示解析到的人员/标签（SSE）
- 网页预览每张图片的缩略图与元数据
- 选择人员后生成移动计划，将图片移动到“目标根目录/人员名/”
- 缩略图缓存（按路径+修改时间+大小哈希）

## 安装

1. 创建并激活虚拟环境（可选）：

```cmd
python -m venv .venv
.venv\Scripts\activate
```

2. 安装依赖：

```cmd
pip install -r requirements.txt
```

注意：libxmp 可选，如果安装失败，程序仍可运行，只是 XMP 解析能力受限。

## 运行

方式一（推荐，自动创建虚拟环境、安装依赖并自动打开浏览器）：

```cmd
start_web.bat
```

方式二（极简启动，仅使用系统 Python；若方式一在你的环境下报“此时不应有 …”之类的批处理语法错误，可用此方式）：

```cmd
start_web_simple.bat
```

方式三（手动运行）：

```cmd
python -m app.server
```

手动方式运行后，浏览器也会自动打开至 http://127.0.0.1:5000

## 实时扫描显示（SSE）
点击“扫描”后，页面通过 Server-Sent Events 与后端建立流式通道，后端每处理一张图片就推送一次，前端即时渲染：
- 已识别出人员：下拉框列出人员名称
- 未识别出人员：下拉框显示“无人员”，不会纳入移动计划
- 解析到的标签会以小圆角标签展示

若浏览器/网络环境不支持 SSE，将自动降级为一次性扫描接口。

### 故障排查（Windows 批处理）
- “此时不应有 …。”：这是 cmd 在某些本地化和编码设置下对括号/ELSE 的解析问题。请改用 `start_web_simple.bat`，或在管理员/不同编码的 cmd 下重试。

## 使用说明
- 源目录：选择要扫描的图片目录
- 目标根目录：移动后的根目录，程序会在其下创建“人员名”子目录
- 扫描后仅展示含“人员”信息的图片。无人员信息的图片将被忽略（按需求）
- 可在每张图片上选择一个“人员”，作为该图片的目标文件夹名
- “生成移动预览”：在页面底部显示前若干项的移动计划文本
- “执行移动”：将文件复制到目标后删除源文件，以兼容可能的跨盘移动

## 已知限制与说明
- XMP 解析依赖 libxmp；若不可用，则仅能从 EXIF XPKeywords 读取关键词，可能无法获取“人员”
- 多人物图片：页面将默认选中第一个检测到的人名，可手动切换；若多个图片人员为空，将不会被移动
- 支持的图片类型：jpg/jpeg/png/gif/bmp/webp/tif/tiff
- Windows 路径中包含中文是支持的；目标文件夹名会进行安全处理（尽量保留中文）

## 故障排查
- 若缩略图不显示：确认图片可读，且为支持格式；查看 `app/cache/` 是否生成缓存
- 若移动失败：检查权限与目标磁盘空间；查看后端返回的 errors 列表
- 需要更多 XMP 兼容：安装 `libxmp` 或使用支持写入 XMP 人员信息的工具（如 Lightroom/Bridge）
